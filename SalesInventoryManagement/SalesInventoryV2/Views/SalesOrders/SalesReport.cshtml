@{
    ViewData["Title"] = "Sales Report";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>Sales Report 
                <span class="badge bg-success">V2 Optimized</span>
            </h2>
            <hr />

            @* ✅ OPTIMIZED: AJAX form - no page reload! *@
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label>Start Date:</label>
                            <input type="date" id="startDate" 
                                   class="form-control" 
                                   value="@DateTime.Now.AddMonths(-1).ToString("yyyy-MM-dd")" 
                                   required />
                        </div>
                        <div class="col-md-4">
                            <label>End Date:</label>
                            <input type="date" id="endDate" 
                                   class="form-control" 
                                   value="@DateTime.Now.ToString("yyyy-MM-dd")" 
                                   required />
                        </div>
                        <div class="col-md-4">
                            <label>&nbsp;</label>
                            <button type="button" id="generateReportBtn" class="btn btn-primary w-100">
                                <i class="bi bi-bar-chart-fill"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            @* ✅ Loading Spinner (shown during AJAX call) *@
            <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Generating report...</p>
            </div>

            @* ✅ Report Content (populated via AJAX) *@
            <div id="reportContent" style="display: none;">
                
                @* Summary Cards *@
                <div class="row" id="summaryCards">
                    <div class="col-md-3">
                        <div class="card text-white bg-primary mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Total Orders</h6>
                                <h2 id="totalOrders">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-success mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Total Revenue</h6>
                                <h2 id="totalRevenue">$0.00</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-info mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Completed</h6>
                                <h2 id="completedOrders">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-warning mb-3">
                            <div class="card-body text-dark">
                                <h6 class="card-title">Pending</h6>
                                <h2 id="pendingOrders">0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                @* Top Products Table *@
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-trophy-fill"></i> Top 10 Products by Revenue</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Product Name</th>
                                        <th>Quantity Sold</th>
                                        <th>Orders</th>
                                        <th>Total Revenue</th>
                                    </tr>
                                </thead>
                                <tbody id="topProductsTable">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                @* Top Customers Table *@
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-people-fill"></i> Top 10 Customers</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Customer Name</th>
                                        <th>City</th>
                                        <th>Total Orders</th>
                                        <th>Total Spent</th>
                                        <th>Avg Order</th>
                                    </tr>
                                </thead>
                                <tbody id="topCustomersTable">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">No data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                @* Revenue by Category *@
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-pie-chart-fill"></i> Revenue by Category</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Quantity Sold</th>
                                        <th>Orders</th>
                                        <th>Total Revenue</th>
                                    </tr>
                                </thead>
                                <tbody id="categoryRevenueTable">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Orders
                </a>
            </div>

            @* Performance Timer Display *@
            <div id="performanceInfo" class="alert alert-success mt-3" style="display: none;">
                <strong>⚡ Performance:</strong> Report generated in <span id="loadTime">0</span> ms
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function() {
    // ✅ AJAX Report Generation - NO PAGE RELOAD!
    $('#generateReportBtn').click(function() {
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        // Show loading spinner
        $('#loadingSpinner').show();
        $('#reportContent').hide();
        $('#performanceInfo').hide();
        
        // Start performance timer
        var startTime = performance.now();
        
        // ✅ AJAX call to get report data
        $.ajax({
            url: '@Url.Action("GetSalesReportData", "SalesOrders")',
            type: 'GET',
            data: {
                startDate: startDate,
                endDate: endDate
            },
            success: function(response) {
                if (response.success) {
                    // Calculate load time
                    var endTime = performance.now();
                    var loadTime = Math.round(endTime - startTime);
                    
                    // Update UI with data
                    updateReportUI(response.data);
                    
                    // Hide spinner, show content
                    $('#loadingSpinner').hide();
                    $('#reportContent').fadeIn();
                    
                    // Show performance info
                    $('#loadTime').text(loadTime);
                    $('#performanceInfo').fadeIn();
                } else {
                    alert('Error generating report');
                    $('#loadingSpinner').hide();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('Failed to generate report. Please try again.');
                $('#loadingSpinner').hide();
            }
        });
    });
    
    // Function to update UI with report data
    function updateReportUI(data) {
        // Update summary cards
        $('#totalOrders').text(data.totalOrders.toLocaleString());
        $('#totalRevenue').text('$' + data.totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        $('#completedOrders').text(data.completedOrders.toLocaleString());
        $('#pendingOrders').text(data.pendingOrders.toLocaleString());
        
        // Update Top Products table
        var topProductsHtml = '';
        if (data.topProducts && data.topProducts.length > 0) {
            data.topProducts.forEach(function(product, index) {
                topProductsHtml += '<tr>' +
                    '<td>' + (index + 1) + '</td>' +
                    '<td><strong>' + product.productName + '</strong></td>' +
                    '<td>' + product.totalQuantitySold.toLocaleString() + '</td>' +
                    '<td>' + product.orderCount + '</td>' +
                    '<td class="text-success"><strong>$' + product.totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong></td>' +
                    '</tr>';
            });
        } else {
            topProductsHtml = '<tr><td colspan="5" class="text-center text-muted">No data for this period</td></tr>';
        }
        $('#topProductsTable').html(topProductsHtml);
        
        // Update Top Customers table
        var topCustomersHtml = '';
        if (data.topCustomers && data.topCustomers.length > 0) {
            data.topCustomers.forEach(function(customer, index) {
                topCustomersHtml += '<tr>' +
                    '<td>' + (index + 1) + '</td>' +
                    '<td><strong>' + customer.customerName + '</strong></td>' +
                    '<td>' + (customer.city || 'N/A') + '</td>' +
                    '<td>' + customer.totalOrders + '</td>' +
                    '<td class="text-success"><strong>$' + customer.totalSpent.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong></td>' +
                    '<td>$' + customer.averageOrderValue.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td>' +
                    '</tr>';
            });
        } else {
            topCustomersHtml = '<tr><td colspan="6" class="text-center text-muted">No data for this period</td></tr>';
        }
        $('#topCustomersTable').html(topCustomersHtml);
        
        // Update Category Revenue table
        var categoryHtml = '';
        if (data.revenueByCategory && data.revenueByCategory.length > 0) {
            data.revenueByCategory.forEach(function(category) {
                categoryHtml += '<tr>' +
                    '<td><strong>' + category.categoryName + '</strong></td>' +
                    '<td>' + category.totalQuantity.toLocaleString() + '</td>' +
                    '<td>' + category.orderCount + '</td>' +
                    '<td class="text-success"><strong>$' + category.totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong></td>' +
                    '</tr>';
            });
        } else {
            categoryHtml = '<tr><td colspan="4" class="text-center text-muted">No data for this period</td></tr>';
        }
        $('#categoryRevenueTable').html(categoryHtml);
    }
    
    // Auto-generate report on page load
    $('#generateReportBtn').click();
});
</script>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
}

